(function(){function exportOverlayController($scope,uSyncHub,uSyncExporterService){function getItems(selection){var items=prepItems(selection,$scope.model.options);uSyncExporterService.getSyncItems(items).then(function(result){vm.options.request.items=result.data;vm.loading=!1},function(error){console.log(error);vm.loading=!1;vm.valid=!1;$scope.model.hideSubmitButton=!0;vm.error=error.data})}function prepItems(selection,options){var items=[];for(let n=0;n<selection.length;n++)items.push({id:selection[n].id,udi:selection[n].udi,name:selection[n].name,nodeType:selection[n].nodeType,entityType:selection[n].entityType,includeChildren:selection[n].flags.includeChildren,includeAncestors:selection[n].flags.includeAncestors,includeDependencies:selection[n].flags.includeDependencies,includeMedia:options.includeMedia,includeConfig:options.includeConfig,includeLinked:options.includeLinked,includeViews:options.includeFiles});return options.includeDictionary&&items.push({id:-1,udi:"umb://dictionary-item/00000000-0000-0000-0000-000000000000",includeChildren:!0,name:"All dictionary items"}),items}function createExport(){$scope.model.disableSubmitButton=!0;$scope.model.submitButtonState="busy";vm.exporting=!0;processExport()}function processExport(){vm.options.clientId=getClientId();uSyncExporterService.createExport(vm.options).then(function(result){var response=result.data;vm.options.id=response.id;vm.options.request.items=response.response.items;vm.progress=response.progress;response.exportComplete?getExport():(vm.options.stepIndex=response.stepIndex,vm.options.request.pageNumber=response.nextPage,processExport())})}function getExport(){vm.update.Message="Compressing `Sync-Pack'";uSyncExporterService.getExport(vm.options).then(function(){$scope.model.hideSubmitButton=!0;$scope.model.closeButtonLabel="Done";vm.update.Count=100;vm.update.Total=100;vm.exporting=!1;vm.complete=!0})}function calcPercentage(update){return update!=null&&update!=undefined?update.count/update.total*100:0}function initSignalRHub(){uSyncHub.initHub(function(hub){vm.hub=hub;vm.hub.on("update",function(update){vm.update=update;vm.update.blocks=update.message.split("||")});vm.hub.on("add",function(status){vm.status=status});vm.hub.start()})}function getClientId(){return $.connection!==undefined?$.connection.connectionId:""}var vm=this;vm.exporting=!1;vm.loading=!0;vm.valid=!0;vm.complete=!1;vm.update={};$scope.model.exported=!1;$scope.model.create=createExport;vm.options={id:"00000000-0000-0000-0000-000000000000",name:"syncpack_"+moment().format("YYYY_MM_DD_hhmmss"),stepIndex:0,request:{pageNumber:0,items:[],options:{removeOrphans:!1,includeFiles:$scope.model.options.includeFiles,includeFileHash:!1,includeSystemFiles:!1,includeMediaFiles:$scope.model.options.includeMedia}},clientId:getClientId()};vm.selection=$scope.model.options.selection;getItems(vm.selection);vm.calcPercentage=calcPercentage;initSignalRHub()}angular.module("umbraco").controller("uSyncExportOverlayController",exportOverlayController)})()