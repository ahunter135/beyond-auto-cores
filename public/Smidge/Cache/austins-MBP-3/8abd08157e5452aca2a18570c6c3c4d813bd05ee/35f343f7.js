(function(){"use strict";function optionsController($scope,dateHelper,userService,uSyncPublishService,uSyncActionManager){function InitOptions(){var flags=uSyncPublishService.getFlags(pvm.flags);pvm.mode.startsWith("file")===!0&&(flags=0,pvm.process.options.includeContent=!0);_.map(pvm.items,function(item){item.flags=flags});pvm.items.length>1&&(pvm.flags.deleteMissing.value=!1);pvm.process.options.items=pvm.items;pvm.process.options.removeOrphans=pvm.flags.deleteMissing.value;pvm.process.options.includeFileHash=pvm.flags.includeFiles.value;evts.push($scope.$watch("pvm.flags",function(newVal){newVal!==undefined&&(updateItemFlags(pvm.flags),pvm.process.options.removeOrphans=pvm.flags.deleteMissing.value,pvm.process.options.includeFileHash=pvm.flags.includeFiles.value)},!0));pvm.showtoggle=shouldShowAdvanced();pvm.showAdvanced=!pvm.showtoggle}function updateItemFlags(flags){var flagValue=uSyncPublishService.getFlags(flags);pvm.process.items.forEach(function(item){item.flags=flagValue})}function shouldShowAdvanced(){if(!pvm.server.sendSettings.hideAdvanced)return!1;if(pvm.action.actionOptions.canSchedule===!0)return!0;for(var flag in pvm.flags)if(flag!="includeChildren"&&flag!=="deleteMissing"&&pvm.flags[flag].toggle==!0)return!0;return!1}function datePickerSetup(instance){pvm.flatPickr=instance}function datePickerChange(date){if(date){var serverTime=dateHelper.convertToServerStringTime(moment(date),Umbraco.Sys.ServerVariables.application.serverTimeOffset);pvm.releaseDate=serverTime;pvm.releaseDateFormatted=dateHelper.getLocalDate(pvm.releaseDate,pvm.currentUser.locale,"MMM Do YYYY, HH:mm");pvm.process.options.attributes.releaseDate=serverTime}}function datePickerShow(){}function datePickerClose(){}function clearPublishDate(){pvm.process.options.attributes.releaseDate=null;pvm.releaseDate=null;var now=new Date,nowFormatted=moment(now).format("YYYY-MM-DD HH:mm");pvm.flatPickr.set("minDate",nowFormatted)}var pvm=this,evts=[];pvm.process=$scope.vm.process;pvm.headings=$scope.vm.headings;pvm.mode=$scope.vm.mode;pvm.contentType=$scope.vm.contentType;pvm.flags=$scope.vm.flags;pvm.action=pvm.process.action;pvm.server=$scope.vm.server;pvm.showtoggle=pvm.server.sendSettings.hideAdvanced;pvm.showAdvanced=!pvm.showtoggle;pvm.headings!==null&&(pvm.headings.boxTitle=pvm.server.name+": Settings",pvm.headings.boxDescription=uSyncActionManager.getDescription(pvm.mode,pvm.contentType,pvm.server.name));pvm.items=pvm.process.items;pvm.firstItem=pvm.items[0];pvm.contentName=pvm.firstItem.name;pvm.showChildren=pvm.items.length>1||pvm.firstItem.hasChildren;InitOptions();$scope.$on("$destroy",function(){for(var e in evts)evts[e]()});$scope.$on("sync-server-selected",function(event,args){pvm.server=args.server});pvm.process.options.attributes={};pvm.process.options.attributes.releaseDate=null;pvm.currentUser=null;pvm.releaseDateFormatted=null;pvm.datePickerSetup=datePickerSetup;pvm.datePickerChange=datePickerChange;pvm.datePickerShow=datePickerShow;pvm.datePickerClose=datePickerClose;pvm.clearPublishDate=clearPublishDate;pvm.flatPickr=null;userService.getCurrentUser().then(function(currentUser){pvm.currentUser=currentUser;var now=new Date,nowFormatted=moment(now).format("YYYY-MM-DD HH:mm");pvm.datePickerConfig={enableTime:!0,dateFormat:"Y-m-d H:i",time_24hr:!0,minDate:nowFormatted,defaultDate:nowFormatted}})}angular.module("umbraco").controller("uSyncPublisherOptionsController",optionsController)})()