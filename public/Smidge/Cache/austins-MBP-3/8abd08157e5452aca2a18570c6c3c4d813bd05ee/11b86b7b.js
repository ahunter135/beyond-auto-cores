(function(){"use strict";function cacheOverlayController($scope,$q,notificationsService,uSyncDependencyManager,uSyncCacheService){function rebuildCache(){function processRebuild(itemType){calcOffset(i);vm.cacheTypes[i].active=!0;i++;rebuildEntityType(itemType).then(function(){i<vm.cacheTypes.length?(vm.cacheTypes[i-1].active=!1,processRebuild(vm.cacheTypes[i])):(flushCache(),$scope.model.closeButtonLabel="Done",$scope.model.rebuilt=!0,$scope.model.hideSubmitButton=!0)},function(){notificationsService.error("error","there where problems rebuilding the cache")})}$scope.model.disableSubmitButton=!0;$scope.model.submitButtonState="busy";vm.rebuilding=!0;vm.error="";var i=0;uSyncCacheService.clearCaches("publisher").then(function(){processRebuild(vm.cacheTypes[0])})}function rebuildEntityType(itemType){return $q(function(resolve,reject){vm.status={Title:"Rebuilding "+itemType.name,Icon:itemType.icon,Message:"Collecting items",Progress:0};uSyncCacheService.getAllUdis(itemType.type).then(function(result){var batches=uSyncDependencyManager.createBatches(result.data,10);processItems(itemType.type,batches).then(function(){resolve()},function(error){reject(error)})})})}function processItems(entityType,batches){return $q(function(resolve,reject){function process(items){i++;vm.status.Message="Processing batch "+i+" of "+batches.length;vm.status.Progress=i/batches.length*100;uSyncCacheService.cacheItems(entityType,"publisher",items).then(function(){i<batches.length?process(batches[i]):(vm.status.Message="Complete",resolve())},function(error){reject(error)})}var i=0;process(batches[i])})}function flushCache(){uSyncCacheService.flush("publisher").then(function(){},function(){notificationsService.error("error","unable to save cache to disk, check logs")})}function calcOffset(n){var offset=vm.offset-75*n;vm.offsetStyle={transform:"translateX("+offset+"px)"}}var vm=this;vm.rebuilding=!1;$scope.model.rebuilt=!1;$scope.model.rebuild=rebuildCache;$scope.model.submitButtonLabel="rebuild";vm.status={Title:"Rebuilding uSync Caches",Message:"Collecting items",Progress:0};vm.offset=230;vm.offsetStyle={transform:"translateX("+vm.offset+"px)"};vm.batchSize=25;vm.cacheTypes=[{name:"Data types",type:"data-type",icon:"icon-autofill",active:!0},{name:"Content Types",type:"document-type",icon:"icon-item-arrangement"},{name:"Media Types",type:"media-type",icon:"icon-thumbnails"},{name:"Content",type:"document",icon:"icon-document color-orange"},{name:"Media",type:"media",icon:"icon-picture color-green"}]}angular.module("umbraco").controller("uSyncCacheOverlayController",cacheOverlayController)})()