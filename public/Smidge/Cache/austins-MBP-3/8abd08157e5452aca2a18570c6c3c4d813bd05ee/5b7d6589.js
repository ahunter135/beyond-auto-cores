(function(){"use strict";function serverSettingsController($scope,$routeParams,$timeout,$http,$rootScope,navigationService,notificationsService,localizationService,uSyncPublishService,uSyncPublishDialogManager,uSyncPublishServerManager){function selectItem(){}function Init(){getSettings();uSyncPublishService.getPublishers().then(function(result){vm.publishers=result.data});var serverAlias=$routeParams.id;if($scope.model!=null&&(serverAlias=$scope.model.serverAlias,vm.showClose=!0),vm.alias!==serverAlias&&(vm.alias=serverAlias,vm.alias!=="-1")){loadServer();return}}function getSettings(){uSyncPublishService.getSettings().then(function(result){vm.settings=result.data;vm.settings.hasAppId||uSyncPublishServerManager.createLocalApiKeys()})}function loadServer(){uSyncPublishService.getServer(vm.alias).then(function(result){vm.server=result.data;vm.server||(vm.server={});initPicker();checkServer(!1);vm.loading=!1},function(error){notificationsService.error("Error",error.data.ExceptionMessage)})}function initPicker(){(vm.server.allowedServers===undefined||vm.server.allowedServers===null||vm.server.allowedServers.length===0)&&(vm.server.allowedServers=[]);vm.allowedPicker={value:vm.server.allowedServers,view:Umbraco.Sys.ServerVariables.uSyncPublisher.pluginPath+"serverPicker/picker.html",validation:{mandatory:!0},config:{multiPicker:!1}};vm.userGroupPicker={value:vm.server.sendSettings,view:Umbraco.Sys.ServerVariables.uSyncPublisher.pluginPath+"pickers/userGroupPicker.html",validation:{mandatory:!1},config:{}}}function save(){vm.saved=!1;vm.buttonState="busy";uSyncPublishService.saveServer(vm.server).then(function(){vm.buttonState="success";notificationsService.success("Saved",vm.server.alias+" server settings have been updated");navigationService.syncTree({tree:"uSyncPublisher",path:["-1",vm.server.alias],forceReload:!0});vm.saved=!0;vm.checked=!1;$rootScope.$broadcast("usync-publish-serverSave");checkServer(!1);Init()},function(error){vm.buttonState="error";notificationsService.error("error",error.data.exceptionMessage)})}function close(){$scope.model.close&&$scope.model.close()}function checkServer(showSuccessBar){vm.checked=!0;vm.checkStatus="busy";vm.status={};uSyncPublishServerManager.checkServer(vm.server.alias,showSuccessBar,function(status){vm.status=status;status!=null?(vm.checkStatus="success",vm.checkStatusButton=status,vm.saved=!1,$timeout(()=>{vm.checked=!1},3500)):(getServerError(status),vm.checkStatus="error")})}function getServerError(status){console.log("getServerError",status);status.enabled||localizationService.localize("usyncpublish_error_"+status.status.toLowerCase()).then(function(value){vm.errorDesc=value.startsWith("[")&&value.endsWith("]")?status.status:value})}function deploy(){uSyncPublishDialogManager.openConfigDialog("Push",vm.server.alias,function(){})}function pullDeploy(){uSyncPublishDialogManager.openConfigDialog("Pull",vm.server.alias,function(){})}function remoteSetup(server){uSyncPublishServerManager.remoteSetup(server,function(){checkServer(!1);vm.checked=!0})}var vm=this,pluginPath,unsubscribe;vm.loading=!0;vm.checked=!1;vm.showClose=!1;vm.showAdvanced=!0;vm.errorDesc="";vm.selectItem=selectItem;pluginPath=Umbraco.Sys.ServerVariables.uSyncPublisher.pluginPath;vm.page={title:"[Server name]",description:"[Server description]",navigation:[{name:"Server",alias:"settings",icon:"icon-server",description:"Settings",view:pluginPath+"server/settings.html",active:!0},{name:"Permissions",alias:"permissions",icon:"icon-combination-lock",description:"a",view:pluginPath+"server/permissions.html"},{name:"Advanced",alias:"advanced",icon:"icon-settings-alt",description:"b",view:pluginPath+"server/advanced.html"}]};vm.buttonState="init";vm.checkStatus="init";vm.checkStatusButton="Check access";vm.status={enabled:!1};vm.server={id:"",sendSettings:{groups:["admin","editor"]},icon:"icon-server",allowedServers:[]};vm.syncbuttons={defaultButton:{labelKey:"usyncpublish_deploy",handler:deploy},subButtons:[{labelKey:"usyncpublish_pullDeploy",handler:pullDeploy}]};vm.save=save;vm.close=close;vm.checkServer=checkServer;vm.deploy=deploy;vm.pullDeploy=pullDeploy;vm.remoteSetup=remoteSetup;$timeout(function(){vm.showClose||navigationService.syncTree({tree:"uSyncPublisher",path:vm.alias})});Init();unsubscribe=[];unsubscribe.push($scope.$watch("vm.server.Publisher",function(newValue){if(newValue!==undefined){var pub=_.find(vm.publishers,function(pub){return pub.alias===newValue});pub!=null&&(vm.publisherDescription=pub.description)}}));$scope.$on("$destroy",function(){for(var u in unsubscribe)unsubscribe[u]()})}angular.module("umbraco").controller("uSyncPublisherServerSettingsController",serverSettingsController)})()