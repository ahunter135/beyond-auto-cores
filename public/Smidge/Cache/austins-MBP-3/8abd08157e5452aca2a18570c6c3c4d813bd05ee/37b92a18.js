(function(){"use strict";function importController($scope,navigationService,notificationsService,uSyncExporterService,Upload,uSyncHub){function close(){$scope.model.close?$scope.model.close():navigationService.hideDialog()}function countChanges(changes){var count=0;return angular.forEach(changes,function(val){val.Change!=="NoChange"&&count++}),count}function handleFiles(files){files&&files.length>0&&(vm.file=files[0])}function upload(file){vm.buttonState="busy";vm.running=!0;vm.uploaded=!1;Upload.upload({url:Umbraco.Sys.ServerVariables.uSync.exporterService+"UploadFile",fields:{clientId:getClientId()},file:file}).success(function(data){vm.buttonState="success";vm.running=!1;vm.uploaded=!0;vm.importId=data.id;initOptions();reportPack()}).error(function(evt,status){vm.running=!1;vm.buttonState="error";notificationsService.error("error","Failed to upload "+status)})}function reportPack(){vm.state="busy";uSyncExporterService.reportPack(vm.options).then(function(result){var response=result.data;vm.options.id=response.id;vm.progress=response.progress;response.response.success?(updateActions(response),response.exportComplete?vm.state="report":(vm.options.stepIndex=response.stepIndex,vm.options.request.pageNumber=response.nextPage,vm.options.request.handlerFolder=response.nextFolder,reportPack())):(vm.state="error",vm.errorMessage=response.response.message)},function(error){handleError(error)})}function handleError(error){vm.running=!1;vm.progress.steps[vm.progress.currentStepIndex].status="Error";vm.buttonState="error";vm.showError=!0;vm.errorMessage=getError(error.data);console.log(error);notificationsService.error("error",vm.errorMessage)}function getError(error){var key=Object.keys(error).find(k=>k.toLowerCase()==="exceptionmessage");if(key!==undefined)return error[key]}function importPack(){initOptions();processImport()}function processImport(){vm.state="busy";uSyncExporterService.importPack(vm.options).then(function(result){var response=result.data;vm.options.id=response.id;vm.progress=response.progress;updateActions(response);response.exportComplete?vm.state="imported":(vm.options.stepIndex=response.stepIndex,vm.options.request.pageNumber=response.nextPage,vm.options.request.handlerFolder=response.nextFolder,processImport())},function(error){handleError(error)})}function updateActions(response){if(response!=null&&response.response!=null){var actions=response.response.actions;actions!==undefined&&actions!==null&&actions.length>0&&(vm.report=actions)}}function initOptions(){vm.options={id:vm.importId,stepIndex:0,request:{pageNumber:0},clientId:getClientId()}}function InitHub(){uSyncHub.initHub(function(hub){vm.hub=hub;vm.hub.on("update",function(update){vm.update=update});vm.hub.on("add",function(data){vm.status=data});vm.hub.start()})}function getClientId(){return $.connection!==undefined?$.connection.connectionId:""}function calcPercentage(status){return status!==undefined?100*status.count/status.total:1}function getTypeName(typeName){var umbType=typeName.substring(0,typeName.indexOf(","));return umbType.substring(umbType.lastIndexOf(".")+1)}var vm=this;vm.buttonState="init";vm.importGroup={defaultButton:{labelKey:"usync_import",handler:function(){vm.importPack(vm.importId,!1)}}};vm.options={};vm.close=close;vm.handleFiles=handleFiles;vm.upload=upload;vm.importPack=importPack;vm.reportPack=reportPack;vm.countChanges=countChanges;vm.file=null;vm.report=[];vm.state="init";vm.imported=!1;vm.running=!1;vm.uploaded=!1;vm.update={Message:"Importing",Count:1,Total:1};InitHub();vm.calcPercentage=calcPercentage;vm.getTypeName=getTypeName;vm.calcPercentage=calcPercentage}angular.module("umbraco").controller("uSyncExporterImportController",importController)})()