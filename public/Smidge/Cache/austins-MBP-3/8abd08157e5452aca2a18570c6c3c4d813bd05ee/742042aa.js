(function(){"use strict";function browserDashboard($scope,appState,uSyncPublishService,uSyncPublishDialogManager){function onNextPage(pageNumber){loadPage(pageNumber)}function onPrevPage(pageNumber){loadPage(pageNumber)}function onChangePage(pageNumber){loadPage(pageNumber)}function onGotoPage(pageNumber){loadPage(pageNumber)}function loadPage(pageNumber){vm.pageNum=pageNumber;vm.currentKey!=null?getFolders(vm.currentKey,vm.pageNum,!1):onSelected(vm.server,vm.pageNum)}function checkServers(servers){servers.forEach(function(server){uSyncPublishService.checkServer(server.alias).then(function(result){server.status=result.data})})}function openDialog(){vm.section==="content"?vm.local?uSyncPublishDialogManager.openPublisherPushContent({items:vm.selected},function(result){result&&refresh()}):uSyncPublishDialogManager.openPublisherPullContent({serverAlias:vm.server.alias,items:vm.selected},function(result){result&&refresh()}):vm.local?uSyncPublishDialogManager.openPublisherPushMedia({items:vm.selected},function(result){result&&refresh()}):uSyncPublishDialogManager.openPublisherPullMedia({serverAlias:vm.server.alias,items:vm.selected},function(result){result&&refresh()})}function selectLocal(){vm.local=!0;vm.selectionLabel="Push selection";vm.picked=!1;vm.server={name:"local"};vm.servers.forEach(function(server){server.selected=!1});vm.items={};clearSelection();vm.pageNum=1;getFolders(vm.rootKey,vm.pageNum)}function onSelected(server){vm.picked=!0;vm.local=!1;vm.selectionLabel="Pull selection";vm.server=server;vm.loading=!0;vm.pageNum=1;getFolders(vm.rootKey,vm.pageNum)}function getFolders(key,page,clear=true){vm.loading=!0;vm.currentKey=key;clear&&clearSelection();vm.local?vm.section==="content"?uSyncPublishService.getLocalContentFolders(key,page).then(function(result){vm.items=result.data;vm.loading=!1;checkContentItems(vm.local);updateSelection()}):uSyncPublishService.getLocalMediaFolders(key,page).then(function(result){vm.items=result.data;vm.loading=!1;checkMediaItems(vm.local);updateSelection()}):vm.section==="content"?uSyncPublishService.getContentFolders(key,vm.server.alias,page).then(function(result){vm.items=result.data;vm.loading=!1;checkContentItems(vm.local);updateSelection()}):uSyncPublishService.getMediaFolders(key,vm.server.alias,page).then(function(result){vm.items=result.data;vm.loading=!1;checkMediaItems(vm.local);updateSelection()})}function updateSelection(){_.forEach(vm.items.nodes,function(node){var selected=_.any(vm.selected,function(s){return s.udi==node.udi});node.selected=selected})}function checkContentItems(local){if(local&&vm.items!=null)setLocal(vm.items.folders),setLocal(vm.items.nodes);else{var udis=_.union(_.pluck(vm.items.folders,"udi"),_.pluck(vm.items.nodes,"udi"));uSyncPublishService.getContentChanges(udis,vm.server.alias).then(function(results){updateChanges(vm.items.folders,results.data);updateChanges(vm.items.nodes,results.data)})}}function setLocal(items){items!==null&&items!==undefined&&items.forEach(function(item){item.local=!0})}function checkMediaItems(local){if(local&&vm.items!=null)setLocal(vm.items.folders),setLocal(vm.items.nodes);else{var udis=_.union(_.pluck(vm.items.folders,"udi"),_.pluck(vm.items.nodes,"udi"));uSyncPublishService.getMediaChanges(udis,vm.server.alias).then(function(results){updateChanges(vm.items.folders,results.data);updateChanges(vm.items.nodes,results.data)})}}function updateChanges(items,changes){items!==null&&items!==undefined&&items.forEach(function(item){var index=_.findIndex(changes,{udi:item.udi});index!=-1&&(item.syncChecked=!0,item.syncAction=changes[index].action,item.syncChange=changes[index].action.change!="NoChange")})}function refresh(){clearSelection();vm.pageNum=1;vm.currentKey!=null?getFolders(vm.currentKey,vm.pageNum):onSelected(vm.server,vm.pageNum)}function clearSelection(){vm.selected=[];clearsSelectedItems(vm.items.folders);clearsSelectedItems(vm.items.nodes)}function clearsSelectedItems(items){if(items!==undefined&&items!==null)for(let i=0;i<items.length;i++)items[i].selected=!1}var vm=this;vm.section=appState.getSectionState("currentSection");vm.servers=[];vm.server={};vm.picked=!1;vm.openDialog=openDialog;vm.getFolders=getFolders;vm.clearSelection=clearSelection;vm.onSelected=onSelected;vm.selectionLabel="Pull selection";vm.selectLocal=selectLocal;vm.local=!1;vm.rootKey="00000000-0000-0000-0000-000000000000";vm.isBlank=!1;vm.mode="pull";vm.items={folders:[],nodes:[]};uSyncPublishService.getServers(vm.mode).then(function(result){vm.servers=result.data;checkServers(vm.servers)});uSyncPublishService.hasContentOrMedia(!1).then(function(result){vm.isBlank=!result.data});vm.layouts=[{name:"Grid",icon:"icon-thumbnails-small",path:"gridpath",selected:!0,active:!0},{name:"List",icon:"icon-list",path:"listpath",selected:!0}];vm.section==="content"?(vm.activeLayout=vm.layouts[1],vm.layouts[0].active=!1,vm.layouts[1].active=!0):vm.activeLayout=vm.layouts[0];vm.pageNum=1;vm.onNextPage=onNextPage;vm.onPrevPage=onPrevPage;vm.onChangePage=onChangePage;vm.onGotoPage=onGotoPage;vm.selected=[]}angular.module("umbraco").controller("uSyncPublisherBrowserDashboardController",browserDashboard)})()